name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # Go ã®ãƒªãƒ³ãƒˆ
  golang-lint:
    name: Go Lint
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        
    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-
        
    - name: Run golangci-lint
      uses: golangci/golangci-lint-action@v3
      with:
        version: v1.55.2
        args: --timeout=10m --verbose
        
    - name: Go module verification
      run: |
        go mod verify
        go mod tidy
        git diff --exit-code go.mod go.sum

  # Go ã®åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆ
  golang-test:
    name: Go Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - pet-service
          - auth-service
          - user-service
          - match-service
          - chat-service
          - api-gateway
    
    services:
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
          
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        
    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-
          
    - name: Download dependencies
      run: go mod download
      
    - name: Wait for Redis
      run: |
        echo "Waiting for Redis to be ready..."
        for i in {1..30}; do
          if redis-cli -h localhost -p 6379 ping > /dev/null 2>&1; then
            echo "Redis is ready!"
            break
          fi
          echo "Waiting... ($i/30)"
          sleep 2
        done
      
    - name: Run ${{ matrix.service }} tests
      run: |
        echo "ğŸ§ª Running tests for ${{ matrix.service }}..."
        
        # ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã—ã¦ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        if [ -d "services/${{ matrix.service }}" ]; then
          cd services/${{ matrix.service }}
          
          # ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          if ls *_test.go 1> /dev/null 2>&1 || find . -name "*_test.go" -type f | grep -q .; then
            echo "ğŸ“‹ Found test files for ${{ matrix.service }}"
            
            # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
            go test -v -race -timeout=10m -coverprofile=coverage.out ./...
            
            # ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
            if [ -f coverage.out ]; then
              go tool cover -html=coverage.out -o coverage.html
              echo "ğŸ“Š Coverage report generated: coverage.html"
              
              # ã‚«ãƒãƒ¬ãƒƒã‚¸è©³ç´°å‡ºåŠ›
              echo "ğŸ“ˆ Coverage details:"
              go tool cover -func=coverage.out | tail -1
            fi
          else
            echo "âš ï¸  No test files found for ${{ matrix.service }}, skipping..."
            exit 0
          fi
        else
          echo "âŒ Service directory not found: services/${{ matrix.service }}"
          exit 1
        fi
      env:
        GO_ENV: test
        REDIS_HOST: localhost
        REDIS_PORT: 6379
        REDIS_PASSWORD: ""
        
    - name: Upload test coverage
      if: matrix.service == 'pet-service'
      uses: actions/upload-artifact@v4
      with:
        name: go-coverage-${{ matrix.service }}
        path: services/${{ matrix.service }}/coverage.*
        retention-days: 7

  # Goãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆ
  golang-benchmark:
    name: Go Benchmarks
    runs-on: ubuntu-latest
    needs: [golang-test]
    if: github.event_name == 'pull_request'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        
    - name: Run benchmarks
      run: |
        echo "ğŸƒâ€â™‚ï¸ Running Go benchmarks..."
        
        # å„ã‚µãƒ¼ãƒ“ã‚¹ã§ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚’å®Ÿè¡Œ
        for service in pet-service auth-service user-service; do
          if [ -d "services/$service" ]; then
            echo "ğŸ“Š Running benchmarks for $service..."
            cd "services/$service"
            
            # ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
            if find . -name "*_test.go" -exec grep -l "func Benchmark" {} \;; then
              go test -bench=. -benchmem -run=^$ ./... | tee "../../benchmark-$service.txt"
            else
              echo "No benchmark tests found for $service"
            fi
            
            cd ../..
          fi
        done
        
    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: go-benchmarks
        path: benchmark-*.txt
        retention-days: 30

  # çµ±åˆçš„ãªGoãƒ†ã‚¹ãƒˆ
  golang-integration:
    name: Go Integration Tests
    runs-on: ubuntu-latest
    needs: [golang-test]
    
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_PASSWORD: testpass
          POSTGRES_USER: testuser
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        
    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-
          
    - name: Download dependencies
      run: go mod download
      
    - name: Setup test data
      run: |
        echo "ğŸ—„ï¸ Setting up test data..."
        
        # Redis ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿
        redis-cli -h localhost -p 6379 SET "test:setup" "ready"
        
        # çµ±åˆãƒ†ã‚¹ãƒˆç”¨ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        make setup-test-data || echo "No setup-test-data target found"
      
    - name: Run integration tests
      run: |
        echo "ğŸ”— Running integration tests..."
        
        # çµ±åˆãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
        go test -v -tags=integration -timeout=15m ./...
      env:
        GO_ENV: test
        REDIS_HOST: localhost
        REDIS_PORT: 6379
        POSTGRES_HOST: localhost
        POSTGRES_PORT: 5432
        POSTGRES_USER: testuser
        POSTGRES_PASSWORD: testpass
        POSTGRES_DB: testdb

  # Web App lint and test
  web-app-test:
    name: Web App Test
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: web-app/package-lock.json

    - name: Install dependencies
      working-directory: web-app
      run: npm ci

    - name: Run TypeScript check
      working-directory: web-app
      run: |
        echo "Running TypeScript check..."
        npx tsc --noEmit

    - name: Run lint
      working-directory: web-app
      run: npm run lint

    - name: Run tests
      working-directory: web-app
      run: npm test -- --coverage --watchAll=false

    - name: Build check
      working-directory: web-app
      run: npm run build

  # Makefileã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ãƒ†ã‚¹ãƒˆ
  makefile-targets:
    name: Makefile Targets
    runs-on: ubuntu-latest
    needs: [golang-lint]
    
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
          
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        
    - name: Test Makefile targets
      run: |
        echo "ğŸ”¨ Testing Makefile targets..."
        
        # åˆ©ç”¨å¯èƒ½ãªã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’è¡¨ç¤º
        echo "Available targets:"
        make help || make list || echo "No help target available"
        
        # é‡è¦ãªMakeã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’ãƒ†ã‚¹ãƒˆ
        echo "Testing core targets..."
        
        # ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
        make build || echo "Build target not available"
        
        # ãƒ†ã‚¹ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
        make test-unit || echo "test-unit target not available"
        make test-pet || echo "test-pet target completed"
        
        # ãƒªãƒ³ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
        make lint || echo "lint target not available"
        
        # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        make clean || echo "clean target not available"
      env:
        GO_ENV: test
        REDIS_HOST: localhost
        REDIS_PORT: 6379

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    continue-on-error: true  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å¤±æ•—ã§ã‚‚CIã‚’ç¶™ç¶š
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        
    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-
        
    - name: Download dependencies
      run: go mod download
        
    - name: Run Gosec Security Scanner
      uses: securego/gosec@master
      with:
        args: '-no-fail -fmt sarif -out gosec.sarif ./...'
        
    - name: Upload SARIF file
      if: always()
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: gosec.sarif
        
    - name: Upload security scan results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: gosec-report
        path: gosec.sarif
        retention-days: 7

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [golang-lint, golang-test, web-app-test]
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        
    - name: Build all Go services
      run: |
        echo "ğŸ”¨ Building all Go services..."
        mkdir -p bin
        
        # å„ã‚µãƒ¼ãƒ“ã‚¹ã‚’ãƒ“ãƒ«ãƒ‰
        for service in pet-service auth-service user-service match-service chat-service api-gateway; do
          if [ -d "services/$service" ]; then
            echo "Building $service..."
            cd "services/$service"
            
            # main.goã®å­˜åœ¨ç¢ºèª
            if [ -f "main.go" ] || [ -f "cmd/main.go" ]; then
              go build -o "../../bin/$service" .
              echo "âœ… Built $service"
            else
              echo "âš ï¸  No main.go found for $service, skipping..."
            fi
            
            cd ../..
          fi
        done
        
        # ãƒ“ãƒ«ãƒ‰çµæœã®ç¢ºèª
        echo "ğŸ“¦ Built binaries:"
        ls -la bin/
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: petmatch-binaries
        path: bin/
        retention-days: 7

  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [build]
    strategy:
      fail-fast: false
      matrix:
        service:
          - pet-service
          - auth-service
          - user-service
          - api-gateway
          - web-app
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver-opts: |
          network=host
    
    - name: Setup build environment
      run: |
        echo "BUILD_ID=${{ github.run_id }}-${{ github.run_attempt }}-${{ strategy.job-index }}" >> $GITHUB_ENV
        echo "DOCKER_BUILDKIT=1" >> $GITHUB_ENV
        docker system prune -f || true

    - name: Build Go services
      if: matrix.service != 'web-app'
      run: |
        echo "ğŸ”¨ Building ${{ matrix.service }}..."
        
        docker build \
          --no-cache \
          --progress=plain \
          --build-arg BUILD_ID=${{ env.BUILD_ID }} \
          -f services/${{ matrix.service }}/Dockerfile \
          -t petmatch/${{ matrix.service }}:${{ github.sha }} \
          .
        
        echo "âœ… Successfully built petmatch/${{ matrix.service }}:${{ github.sha }}"

    - name: Build Web App
      if: matrix.service == 'web-app'
      run: |
        echo "ğŸ”¨ Building Web App..."
        
        docker build \
          --no-cache \
          --progress=plain \
          --build-arg BUILD_ID=${{ env.BUILD_ID }} \
          -f web-app/Dockerfile \
          -t petmatch/web-app:${{ github.sha }} \
          ./web-app
        
        echo "âœ… Successfully built petmatch/web-app:${{ github.sha }}"

  # ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [golang-test, golang-integration, web-app-test, makefile-targets]
    if: always()
    
    steps:
    - name: Test Results Summary
      run: |
        echo "ğŸ“Š PetMatch CI Test Summary"
        echo "=========================="
        echo "ğŸ¹ Go Unit Tests: ${{ needs.golang-test.result }}"
        echo "ğŸ”— Go Integration Tests: ${{ needs.golang-integration.result }}"
        echo "âš›ï¸  Web App Tests: ${{ needs.web-app-test.result }}"
        echo "ğŸ”¨ Makefile Targets: ${{ needs.makefile-targets.result }}"
        echo "=========================="
        
        # å…¨ãƒ†ã‚¹ãƒˆã®æˆåŠŸç¢ºèª
        if [[ "${{ needs.golang-test.result }}" == "success" && \
              "${{ needs.golang-integration.result }}" == "success" && \
              "${{ needs.web-app-test.result }}" == "success" && \
              "${{ needs.makefile-targets.result }}" == "success" ]]; then
          echo "ğŸ‰ All tests passed successfully!"
          echo "::notice title=Tests Passed::All PetMatch tests completed successfully"
        else
          echo "âŒ Some tests failed. Check the individual job results above."
          echo "::error title=Tests Failed::One or more test jobs failed"
        fi

  # çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  integration-test:
    name: Integration Test
    runs-on: ubuntu-latest
    needs: [test-summary, build]
    if: github.ref == 'refs/heads/main' && needs.test-summary.result == 'success'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup test environment
      run: |
        echo "ğŸš€ Setting up integration test environment..."
        echo "âœ… All builds verified - ready for integration testing"
        
        # å°†æ¥çš„ã«Kubernetesãƒ†ã‚¹ãƒˆç’°å¢ƒã‚„Docker Composeã§ã®çµ±åˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè£…
        echo "Integration tests would run here"
