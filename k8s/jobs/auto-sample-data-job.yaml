# è‡ªå‹•ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿æŠ•å…¥Jobï¼ˆæ”¹è‰¯ç‰ˆï¼‰
apiVersion: batch/v1
kind: Job
metadata:
  name: petmatch-auto-sample-data
  namespace: petmatch
  labels:
    app: petmatch-sample-data
    version: v2.0.0
    auto-run: "true"
spec:
  ttlSecondsAfterFinished: 7200  # 2æ™‚é–“å¾Œã«è‡ªå‹•å‰Šé™¤
  backoffLimit: 3  # æœ€å¤§3å›ãƒªãƒˆãƒ©ã‚¤
  activeDeadlineSeconds: 600  # 10åˆ†ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
  template:
    metadata:
      labels:
        app: petmatch-sample-data
    spec:
      restartPolicy: Never
      initContainers:
      # ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•å¾…ã¡
      - name: wait-for-services
        image: busybox:1.35
        command:
        - sh
        - -c
        - |
          echo "ğŸ” Waiting for services to be ready..."
          
          # Pet Serviceå¾…ã¡
          echo "Checking Pet Service..."
          retry_count=0
          max_retries=60  # 5åˆ†é–“å¾…æ©Ÿ
          while [ $retry_count -lt $max_retries ]; do
            if nc -z pet-service 8083; then
              echo "âœ… Pet Service ready"
              break
            fi
            echo "Pet Service not ready, waiting... ($retry_count/$max_retries)"
            sleep 5
            retry_count=$((retry_count + 1))
          done
          
          # Auth Serviceå¾…ã¡
          echo "Checking Auth Service..."
          retry_count=0
          while [ $retry_count -lt $max_retries ]; do
            if nc -z auth-service 8081; then
              echo "âœ… Auth Service ready"
              break
            fi
            echo "Auth Service not ready, waiting... ($retry_count/$max_retries)"
            sleep 5
            retry_count=$((retry_count + 1))
          done
          
          echo "ğŸš€ All services are ready!"
          
      # ãƒ‡ãƒ¼ã‚¿é‡è¤‡ãƒã‚§ãƒƒã‚¯
      - name: check-existing-data
        image: alpine/curl:latest
        command:
        - sh
        - -c
        - |
          echo "ğŸ” Checking for existing data..."
          
          # Pet Serviceæ¥ç¶šç¢ºèª
          if ! curl -s "http://pet-service:8083/health" >/dev/null; then
            echo "âŒ Pet Service not accessible"
            exit 1
          fi
          
          # æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ç¢ºèª
          existing_count=$(curl -s "http://pet-service:8083/pets" 2>/dev/null | grep -o '"total":[0-9]*' | cut -d: -f2 || echo "0")
          echo "ğŸ“Š Existing pets: $existing_count"
          
          # æ—¢ã«ååˆ†ãªãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
          if [ "$existing_count" -ge 20 ]; then
            echo "âœ… Sufficient data exists ($existing_count pets). Skipping data generation."
            # ã‚¹ã‚­ãƒƒãƒ—ãƒ•ãƒ©ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
            touch /shared/skip_generation
          else
            echo "ğŸ“ Need to generate sample data (current: $existing_count)"
          fi
        volumeMounts:
        - name: shared-data
          mountPath: /shared
          
      containers:
      - name: sample-data-generator
        image: alpine:3.18
        command:
        - sh
        - -c
        - |
          # ã‚¹ã‚­ãƒƒãƒ—ãƒ•ãƒ©ã‚°ãƒã‚§ãƒƒã‚¯
          if [ -f /shared/skip_generation ]; then
            echo "ğŸ”„ Sample data generation skipped - sufficient data exists"
            exit 0
          fi
          
          echo "ğŸš€ PetMatch Auto Sample Data Generation"
          echo "======================================"
          
          # å¿…è¦ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          apk add --no-cache curl jq
          
          # ç’°å¢ƒå¤‰æ•°
          PET_SERVICE_URL="http://pet-service:8083"
          AUTH_SERVICE_URL="http://auth-service:8081"
          NUM_PETS=30
          
          echo "Pet Service: $PET_SERVICE_URL"
          echo "Auth Service: $AUTH_SERVICE_URL"
          echo "Target Pets: $NUM_PETS"
          echo ""
          
          # ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿é…åˆ—
          species_list="dog cat bird rabbit hamster"
          names_list="ãƒãƒ ã‚¿ãƒ ã‚³ã‚³ ãƒ¢ãƒ¢ ãƒãƒ§ã‚³ ãƒŸãƒ«ã‚¯ ã‚¯ãƒƒã‚­ãƒ¼ ãƒãƒ­ãƒ³ ãƒ¬ã‚ª ãƒ«ãƒŠ ã‚½ãƒ© ãƒãƒŠ ã‚µã‚¯ãƒ© ã‚³ãƒ†ãƒ„ ã‚·ãƒ­ ã‚¯ãƒ­ ãƒ™ãƒ« ãƒ©ãƒƒã‚¯ ãƒ”ã‚³ ãƒŠãƒŠ ãƒŸãƒŸ ãƒ©ãƒ© ãƒãƒ"
          
          # ãƒ©ãƒ³ãƒ€ãƒ é¸æŠé–¢æ•°
          get_random() {
            echo "$1" | tr ' ' '\n' | shuf -n 1
          }
          
          # å“ç¨®å–å¾—
          get_breed() {
            case $1 in
              "dog") echo "æŸ´çŠ¬" ;;
              "cat") echo "ã‚¢ãƒ¡ãƒªã‚«ãƒ³ã‚·ãƒ§ãƒ¼ãƒˆãƒ˜ã‚¢" ;;
              "bird") echo "ã‚»ã‚­ã‚»ã‚¤ã‚¤ãƒ³ã‚³" ;;
              "rabbit") echo "ãƒ›ãƒ¼ãƒ©ãƒ³ãƒ‰ãƒ­ãƒƒãƒ—" ;;
              "hamster") echo "ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ãƒãƒ ã‚¹ã‚¿ãƒ¼" ;;
              *) echo "ãƒŸãƒƒã‚¯ã‚¹" ;;
            esac
          }
          
          # APIæ¥ç¶šç¢ºèª
          echo "ğŸ“¡ APIæ¥ç¶šç¢ºèª..."
          if ! curl -s "$PET_SERVICE_URL/health" >/dev/null; then
            echo "âŒ Pet Serviceæ¥ç¶šå¤±æ•—"
            exit 1
          fi
          
          if ! curl -s "$AUTH_SERVICE_URL/health" >/dev/null; then
            echo "âŒ Auth Serviceæ¥ç¶šå¤±æ•—"
            exit 1
          fi
          
          echo "âœ… APIæ¥ç¶šæˆåŠŸ"
          
          # èªè¨¼å‡¦ç†
          echo "ğŸ” èªè¨¼å‡¦ç†..."
          
          # ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ï¼ˆã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ï¼‰
          register_data='{"name":"Auto Sample User","email":"auto@petmatch.com","password":"auto123","phone":"090-0000-0000","address":"æ±äº¬éƒ½","type":"adopter"}'
          
          curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "$register_data" \
            "$AUTH_SERVICE_URL/auth/register" >/dev/null 2>&1 || true
          
          # ãƒ­ã‚°ã‚¤ãƒ³
          login_data='{"email":"auto@petmatch.com","password":"auto123"}'
          
          login_response=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "$login_data" \
            "$AUTH_SERVICE_URL/auth/login")
          
          # ãƒˆãƒ¼ã‚¯ãƒ³æŠ½å‡º
          TOKEN=$(echo "$login_response" | jq -r '.tokens.access_token' 2>/dev/null || echo "")
          
          if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
            echo "âŒ èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—å¤±æ•—"
            echo "Response: $login_response"
            exit 1
          fi
          
          echo "âœ… èªè¨¼æˆåŠŸ"
          
          # ã‚µãƒ³ãƒ—ãƒ«ãƒšãƒƒãƒˆç”Ÿæˆ
          echo ""
          echo "ğŸ¾ $NUM_PETS åŒ¹ã®ãƒšãƒƒãƒˆç”Ÿæˆé–‹å§‹..."
          echo ""
          
          success=0
          errors=0
          
          for i in $(seq 1 $NUM_PETS); do
            # ãƒ©ãƒ³ãƒ€ãƒ ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
            species=$(get_random "$species_list")
            breed=$(get_breed "$species")
            name=$(get_random "$names_list")
            gender=$([ $((RANDOM % 2)) -eq 0 ] && echo "male" || echo "female")
            size="medium"
            color="èŒ¶è‰²"
            
            age_years=$((RANDOM % 8 + 1))
            age_months=$((RANDOM % 12))
            
            gender_jp=$([ "$gender" = "male" ] && echo "ã‚ªã‚¹" || echo "ãƒ¡ã‚¹")
            description="${name}ã¯${age_years}æ­³ã®${gender_jp}ã®${breed}ã§ã™ã€‚äººæ‡ã£ã“ã„æ€§æ ¼ã§æ–°ã—ã„å®¶æ—ã‚’å¾…ã£ã¦ã„ã¾ã™ã€‚"
            
            # JSONãƒ‡ãƒ¼ã‚¿ä½œæˆ
            pet_data=$(cat <<EOF
{
  "name": "$name",
  "species": "$species",
  "breed": "$breed",
  "age_years": $age_years,
  "age_months": $age_months,
  "is_estimated": false,
  "gender": "$gender",
  "size": "$size",
  "color": "$color",
  "personality": ["äººæ‡ã£ã“ã„", "æ´»ç™º"],
  "medical_info": {
    "vaccinated": true,
    "neutered": true,
    "health_issues": [],
    "last_checkup": "",
    "medications": []
  },
  "location": "35.6762,139.6503",
  "description": "$description"
}
EOF
)
            
            printf "%-3d. %-8s %-12s %-15s... " "$i" "$species" "$name" "$breed"
            
            # APIå®Ÿè¡Œ
            response=$(curl -s -w "\nHTTP_STATUS:%{http_code}\n" -X POST \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $TOKEN" \
              -d "$pet_data" \
              "$PET_SERVICE_URL/pets")
            
            http_status=$(echo "$response" | grep "HTTP_STATUS:" | cut -d: -f2)
            
            if [ "$http_status" = "201" ] || [ "$http_status" = "200" ]; then
              echo "âœ…"
              success=$((success + 1))
            else
              echo "âŒ (HTTP $http_status)"
              errors=$((errors + 1))
              if [ $errors -le 2 ]; then
                echo "     Error: $(echo "$response" | head -c 80)..."
              fi
            fi
            
            # è² è·è»½æ¸›
            sleep 0.1
          done
          
          echo ""
          echo "ğŸ“Š ç”Ÿæˆçµæœ"
          echo "========================"
          echo "âœ… æˆåŠŸ: $success åŒ¹"
          echo "âŒ å¤±æ•—: $errors åŒ¹"
          echo "ğŸ“Š æˆåŠŸç‡: $(( success * 100 / NUM_PETS ))%"
          
          # æœ€çµ‚ç¢ºèª
          echo ""
          echo "ğŸ” æœ€çµ‚ãƒ‡ãƒ¼ã‚¿ç¢ºèª..."
          total_pets=$(curl -s "$PET_SERVICE_URL/pets" | jq '.total // 0' 2>/dev/null || echo "0")
          echo "ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç·ãƒšãƒƒãƒˆæ•°: $total_pets åŒ¹"
          
          if [ $success -gt 0 ]; then
            echo ""
            echo "ğŸ‰ è‡ªå‹•ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆå®Œäº†ï¼"
            exit 0
          else
            echo ""
            echo "âŒ ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆå¤±æ•—"
            exit 1
          fi
        env:
        - name: TZ
          value: "Asia/Tokyo"
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "100m"
        volumeMounts:
        - name: shared-data
          mountPath: /shared
      volumes:
      - name: shared-data
        emptyDir: {}
