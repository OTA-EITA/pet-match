apiVersion: batch/v1
kind: Job
metadata:
  name: petmatch-sample-data
  namespace: petmatch
  labels:
    app: petmatch-sample-data
    version: v1.0.0
spec:
  ttlSecondsAfterFinished: 3600  # 1æ™‚é–“å¾Œã«ã‚¸ãƒ§ãƒ–ã‚’è‡ªå‹•å‰Šé™¤
  backoffLimit: 3  # æœ€å¤§3å›ãƒªãƒˆãƒ©ã‚¤
  template:
    metadata:
      labels:
        app: petmatch-sample-data
    spec:
      restartPolicy: Never
      initContainers:
      # ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•å¾…ã¡
      - name: wait-for-services
        image: busybox:1.35
        command:
        - sh
        - -c
        - |
          echo "Waiting for Pet Service..."
          until nc -z pet-service 8083; do
            echo "Pet Service not ready, waiting..."
            sleep 5
          done
          echo "Waiting for Auth Service..."
          until nc -z auth-service 8081; do
            echo "Auth Service not ready, waiting..."
            sleep 5
          done
          echo "All services are ready!"
      containers:
      - name: sample-data-generator
        image: petmatch/sample-data:latest
        imagePullPolicy: IfNotPresent
        env:
        - name: PET_SERVICE_URL
          value: "http://pet-service:8083"
        - name: AUTH_SERVICE_URL
          value: "http://auth-service:8081"
        - name: NUM_PETS
          value: "30"
        - name: LOG_LEVEL
          value: "info"
        envFrom:
        - configMapRef:
            name: petmatch-config
        command:
        - /bin/sh
        - -c
        - |
          echo "ğŸš€ PetMatch Sample Data Generation Starting..."
          echo "Pet Service: $PET_SERVICE_URL"
          echo "Auth Service: $AUTH_SERVICE_URL"
          echo "Target Pets: $NUM_PETS"
          echo "======================================"
          
          # ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
          /app/generate-sample-data.sh "$PET_SERVICE_URL" "$AUTH_SERVICE_URL" "$NUM_PETS"
          
          # çµæœç¢ºèª
          echo ""
          echo "ğŸ” Verification..."
          total_pets=$(wget -qO- "$PET_SERVICE_URL/pets" 2>/dev/null | grep -o '"total":[0-9]*' | cut -d: -f2 || echo "0")
          echo "âœ… Total pets created: $total_pets"
          
          if [ "$total_pets" -gt 0 ]; then
            echo "ğŸ‰ Sample data generation completed successfully!"
            exit 0
          else
            echo "âŒ Sample data generation failed"
            exit 1
          fi
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
        volumeMounts:
        - name: sample-data-script
          mountPath: /app
          readOnly: true
      volumes:
      - name: sample-data-script
        configMap:
          name: sample-data-script
          defaultMode: 0755

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: sample-data-script
  namespace: petmatch
  labels:
    app: petmatch-sample-data
data:
  generate-sample-data.sh: |
    #!/bin/sh
    set -e
    
    API_BASE_URL=${1:-"http://pet-service:8083"}
    AUTH_SERVICE_URL=${2:-"http://auth-service:8081"}
    NUM_PETS=${3:-30}
    
    echo "ğŸ¾ PetMatch Container Sample Data Generator"
    echo "Pet Service: $API_BASE_URL"
    echo "Auth Service: $AUTH_SERVICE_URL"
    echo "Pets to create: $NUM_PETS"
    echo "=================================="
    
    # å¿…è¦ãƒ„ãƒ¼ãƒ«ã®ç¢ºèª
    if ! command -v wget >/dev/null 2>&1; then
      echo "Installing wget..."
      apk add --no-cache wget curl
    fi
    
    # ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿é…åˆ—ï¼ˆç°¡ç•¥ç‰ˆï¼‰
    SPECIES="dog cat bird rabbit hamster"
    NAMES="ãƒãƒ ã‚¿ãƒ ã‚³ã‚³ ãƒ¢ãƒ¢ ãƒãƒ§ã‚³ ãƒŸãƒ«ã‚¯ ã‚¯ãƒƒã‚­ãƒ¼ ãƒãƒ­ãƒ³ ãƒ¬ã‚ª ãƒ«ãƒŠ ã‚½ãƒ© ãƒãƒŠ ã‚µã‚¯ãƒ© ã‚³ãƒ†ãƒ„ ã‚·ãƒ­ ã‚¯ãƒ­ ãƒ™ãƒ« ãƒ©ãƒƒã‚¯ ãƒ”ã‚³ ãƒŠãƒŠ"
    GENDERS="male female"
    SIZES="small medium large"
    COLORS="èŒ¶è‰² é»’ ç™½ ã‚°ãƒ¬ãƒ¼ ä¸‰æ¯› èŒ¶ç™½ é»’ç™½"
    PERSONALITIES="æ´»ç™º äººæ‡ã£ã“ã„ ãŠã¨ãªã—ã„ ç”˜ãˆã‚“åŠ å¥½å¥‡å¿ƒæ—ºç›› è­¦æˆ’å¿ƒãŒå¼·ã„ éŠã³å¥½ã ãƒã‚¤ãƒšãƒ¼ã‚¹"
    
    # ãƒ©ãƒ³ãƒ€ãƒ é¸æŠé–¢æ•°
    get_random() {
      echo "$1" | tr ' ' '\n' | shuf -n 1
    }
    
    # å“ç¨®ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆç°¡ç•¥ç‰ˆï¼‰
    get_breed() {
      case $1 in
        "dog") echo "æŸ´çŠ¬" ;;
        "cat") echo "ã‚¢ãƒ¡ãƒªã‚«ãƒ³ã‚·ãƒ§ãƒ¼ãƒˆãƒ˜ã‚¢" ;;
        "bird") echo "ã‚»ã‚­ã‚»ã‚¤ã‚¤ãƒ³ã‚³" ;;
        "rabbit") echo "ãƒ›ãƒ¼ãƒ©ãƒ³ãƒ‰ãƒ­ãƒƒãƒ—" ;;
        "hamster") echo "ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ãƒãƒ ã‚¹ã‚¿ãƒ¼" ;;
        *) echo "ãƒŸãƒƒã‚¯ã‚¹" ;;
      esac
    }
    
    # APIæ¥ç¶šç¢ºèª
    echo "ğŸ“¡ APIæ¥ç¶šç¢ºèªä¸­..."
    if ! wget -q --spider "$API_BASE_URL/health" 2>/dev/null; then
      echo "âŒ Pet Serviceæ¥ç¶šå¤±æ•—: $API_BASE_URL"
      exit 1
    fi
    
    if ! wget -q --spider "$AUTH_SERVICE_URL/health" 2>/dev/null; then
      echo "âŒ Auth Serviceæ¥ç¶šå¤±æ•—: $AUTH_SERVICE_URL"
      exit 1
    fi
    
    echo "âœ… APIæ¥ç¶šæˆåŠŸ"
    
    # èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—
    echo "ğŸ” èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ä¸­..."
    
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
    register_data='{"name":"Sample User","email":"sample@petmatch.com","password":"sample123","phone":"090-1234-5678","address":"æ±äº¬éƒ½æ¸‹è°·åŒº","type":"adopter"}'
    
    wget -q --post-data="$register_data" \
         --header="Content-Type: application/json" \
         "$AUTH_SERVICE_URL/auth/register" -O /dev/null 2>/dev/null || true
    
    # ãƒ­ã‚°ã‚¤ãƒ³
    login_data='{"email":"sample@petmatch.com","password":"sample123"}'
    
    login_response=$(wget -q --post-data="$login_data" \
                          --header="Content-Type: application/json" \
                          "$AUTH_SERVICE_URL/auth/login" -O -)
    
    # ãƒˆãƒ¼ã‚¯ãƒ³æŠ½å‡ºï¼ˆjqä½¿ã‚ãšã«ï¼‰
    TOKEN=$(echo "$login_response" | grep -o '"access_token":"[^"]*"' | cut -d'"' -f4)
    
    if [ -z "$TOKEN" ]; then
      echo "âŒ èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—å¤±æ•—"
      echo "Response: $login_response"
      exit 1
    fi
    
    echo "âœ… èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—æˆåŠŸ"
    
    # ã‚µãƒ³ãƒ—ãƒ«ãƒšãƒƒãƒˆç”Ÿæˆ
    echo ""
    echo "ğŸ¾ $NUM_PETS åŒ¹ã®ãƒšãƒƒãƒˆç”Ÿæˆä¸­..."
    echo ""
    
    success_count=0
    error_count=0
    
    i=1
    while [ $i -le $NUM_PETS ]; do
      # ãƒ©ãƒ³ãƒ€ãƒ ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
      species=$(get_random "$SPECIES")
      breed=$(get_breed "$species")
      name=$(get_random "$NAMES")
      gender=$(get_random "$GENDERS")
      size=$(get_random "$SIZES")
      color=$(get_random "$COLORS")
      personality=$(get_random "$PERSONALITIES")
      
      age_years=$(($(shuf -i 1-10 -n 1)))
      age_months=$(($(shuf -i 0-11 -n 1)))
      
      # ä½ç½®æƒ…å ±ï¼ˆæ±äº¬ã‚¨ãƒªã‚¢ï¼‰
      lat="35.6762"
      lng="139.6503"
      
      # èª¬æ˜æ–‡
      gender_jp=""
      case $gender in
        "male") gender_jp="ã‚ªã‚¹" ;;
        "female") gender_jp="ãƒ¡ã‚¹" ;;
      esac
      
      description="${name}ã¯${age_years}æ­³ã®${gender_jp}ã®${breed}ã§ã™ã€‚${personality}ãªæ€§æ ¼ã‚’ã—ã¦ã„ã¾ã™ã€‚"
      
      # JSONãƒ‡ãƒ¼ã‚¿ä½œæˆ
      pet_data=$(cat <<EOF
    {
      "name": "$name",
      "species": "$species",
      "breed": "$breed",
      "age_years": $age_years,
      "age_months": $age_months,
      "is_estimated": false,
      "gender": "$gender",
      "size": "$size",
      "color": "$color",
      "personality": ["$personality"],
      "medical_info": {
        "vaccinated": true,
        "neutered": true,
        "health_issues": [],
        "last_checkup": "",
        "medications": []
      },
      "location": "$lat,$lng",
      "description": "$description"
    }
    EOF
    )
      
      printf "%-3d. %-8s %-12s %-15s... " "$i" "$species" "$name" "$breed"
      
      # APIçµŒç”±ã§ãƒšãƒƒãƒˆä½œæˆ
      response=$(wget -q --post-data="$pet_data" \
                      --header="Content-Type: application/json" \
                      --header="Authorization: Bearer $TOKEN" \
                      "$API_BASE_URL/pets" -O - 2>/dev/null)
      
      if echo "$response" | grep -q '"id"'; then
        echo "âœ…"
        success_count=$((success_count + 1))
      else
        echo "âŒ"
        error_count=$((error_count + 1))
        if [ $error_count -le 2 ]; then
          echo "     Error: $(echo "$response" | head -c 50)..."
        fi
      fi
      
      # è² è·è»½æ¸›
      sleep 0.2
      i=$((i + 1))
    done
    
    echo ""
    echo "ğŸ“Š ç”Ÿæˆçµæœ"
    echo "======================"
    echo "âœ… æˆåŠŸ: $success_count åŒ¹"
    echo "âŒ å¤±æ•—: $error_count åŒ¹"
    
    if [ $success_count -gt 0 ]; then
      echo ""
      echo "ğŸ‰ ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆå®Œäº†ï¼"
      exit 0
    else
      echo ""
      echo "âŒ ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆå¤±æ•—"
      exit 1
    fi
