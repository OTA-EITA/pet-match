# MinIO Setup Job - Creates buckets and policies
apiVersion: batch/v1
kind: Job
metadata:
  name: minio-setup
  namespace: petmatch
  labels:
    app: minio-setup
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: minio-setup
        image: minio/mc:latest
        command:
        - /bin/sh
        - -c
        - |
          echo "ðŸ”§ MinIO Setup starting..."
          
          # Wait for MinIO to be ready
          until mc alias set petmatch http://minio-service:9000 $MINIO_ROOT_USER $MINIO_ROOT_PASSWORD; do
            echo "â³ Waiting for MinIO to be ready..."
            sleep 5
          done
          
          echo "âœ… MinIO is ready"
          
          # Create buckets
          echo "ðŸ“¦ Creating buckets..."
          mc mb petmatch/pet-images --ignore-existing
          mc mb petmatch/pet-thumbnails --ignore-existing
          
          # Set bucket policies for public read access to images
          echo "ðŸ” Setting bucket policies..."
          cat > /tmp/policy.json << EOF
          {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Principal": {"AWS": "*"},
                "Action": ["s3:GetObject"],
                "Resource": ["arn:aws:s3:::pet-images/*", "arn:aws:s3:::pet-thumbnails/*"]
              }
            ]
          }
          EOF
          
          mc anonymous set download petmatch/pet-images
          mc anonymous set download petmatch/pet-thumbnails
          
          # Create sample directory structure
          echo "ðŸ“ Creating directory structure..."
          echo "Sample content" | mc pipe petmatch/pet-images/.petmatch-initialized
          
          echo "ðŸŽ‰ MinIO setup completed successfully!"
          
          # List buckets to verify
          echo "ðŸ“‹ Bucket list:"
          mc ls petmatch/
        env:
        - name: MINIO_ROOT_USER
          valueFrom:
            secretKeyRef:
              name: petmatch-secrets
              key: MINIO_ACCESS_KEY
        - name: MINIO_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: petmatch-secrets
              key: MINIO_SECRET_KEY
