# OnlyCats Local Development Makefile
# Kubernetesä¸è¦ã§ãƒ­ãƒ¼ã‚«ãƒ«ã§ã‚µãƒ¼ãƒ“ã‚¹ã‚’èµ·å‹•

.PHONY: help dev-start dev-stop dev-status dev-logs dev-clean

# è‰²å®šç¾©
RED=\033[0;31m
GREEN=\033[0;32m
YELLOW=\033[1;33m
BLUE=\033[0;34m
CYAN=\033[0;36m
NC=\033[0m

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆ
ROOT_DIR=$(shell pwd)
LOG_DIR=$(ROOT_DIR)/.logs
PID_DIR=$(ROOT_DIR)/.pids
BIN_DIR=$(ROOT_DIR)/.bin

# .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
ifneq (,$(wildcard ./.env))
    include .env
    export
endif

help:
	@echo "$(CYAN)OnlyCats ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒ$(NC)"
	@echo "$(BLUE)==============================$(NC)"
	@echo ""
	@echo "$(GREEN)åŸºæœ¬ã‚³ãƒžãƒ³ãƒ‰:$(NC)"
	@echo "  make -f Makefile.local dev-start   - å…¨ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•"
	@echo "  make -f Makefile.local dev-stop    - å…¨ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢"
	@echo "  make -f Makefile.local dev-status  - ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ç¢ºèª"
	@echo "  make -f Makefile.local dev-logs    - ãƒ­ã‚°è¡¨ç¤º"
	@echo "  make -f Makefile.local dev-clean   - ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"
	@echo ""

# å…¨ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•
dev-start:
	@echo "$(CYAN)ðŸš€ OnlyCats ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•ä¸­...$(NC)"
	@mkdir -p $(LOG_DIR) $(PID_DIR) $(BIN_DIR)
	@$(MAKE) -f Makefile.local _check-redis
	@$(MAKE) -f Makefile.local _start-auth
	@$(MAKE) -f Makefile.local _start-user
	@$(MAKE) -f Makefile.local _start-pet
	@$(MAKE) -f Makefile.local _start-match
	@$(MAKE) -f Makefile.local _start-gateway
	@sleep 2
	@echo ""
	@$(MAKE) -f Makefile.local dev-status
	@echo ""
	@echo "$(GREEN)âœ… èµ·å‹•å®Œäº†!$(NC)"
	@echo ""
	@echo "$(YELLOW)ã‚¢ã‚¯ã‚»ã‚¹:$(NC)"
	@echo "  API Gateway:   http://localhost:8080"
	@echo "  Auth Service:  http://localhost:18091"
	@echo "  User Service:  http://localhost:18092"
	@echo "  Pet Service:   http://localhost:8083"
	@echo "  Match Service: http://localhost:8084"
	@echo ""
	@echo "$(YELLOW)ãƒ­ã‚°ç¢ºèª:$(NC) make -f Makefile.local dev-logs"
	@echo "$(YELLOW)åœæ­¢:$(NC)     make -f Makefile.local dev-stop"

# å…¨ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢
dev-stop:
	@echo "$(YELLOW)ðŸ›‘ ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢ä¸­...$(NC)"
	@for pid_file in $(PID_DIR)/*.pid; do \
		if [ -f "$$pid_file" ]; then \
			service=$$(basename $$pid_file .pid); \
			pid=$$(cat $$pid_file); \
			if kill -0 $$pid 2>/dev/null; then \
				echo "$(BLUE)  åœæ­¢: $$service (PID: $$pid)$(NC)"; \
				kill $$pid 2>/dev/null || true; \
			fi; \
			rm -f $$pid_file; \
		fi; \
	done
	@echo "$(GREEN)âœ… åœæ­¢å®Œäº†$(NC)"

# ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ç¢ºèª
dev-status:
	@echo "$(CYAN)ðŸ“Š ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹$(NC)"
	@echo "$(BLUE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@printf "  API Gateway (8080):   "
	@curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/health 2>/dev/null | \
		grep -q 200 && echo "$(GREEN)âœ“ OK$(NC)" || echo "$(RED)âœ— DOWN$(NC)"
	@printf "  Auth Service (18091): "
	@curl -s -o /dev/null -w "%{http_code}" http://localhost:18091/health 2>/dev/null | \
		grep -q 200 && echo "$(GREEN)âœ“ OK$(NC)" || echo "$(RED)âœ— DOWN$(NC)"
	@printf "  User Service (18092): "
	@curl -s -o /dev/null -w "%{http_code}" http://localhost:18092/health 2>/dev/null | \
		grep -q 200 && echo "$(GREEN)âœ“ OK$(NC)" || echo "$(RED)âœ— DOWN$(NC)"
	@printf "  Pet Service (8083):   "
	@curl -s -o /dev/null -w "%{http_code}" http://localhost:8083/health 2>/dev/null | \
		grep -q 200 && echo "$(GREEN)âœ“ OK$(NC)" || echo "$(RED)âœ— DOWN$(NC)"
	@printf "  Match Service (8084): "
	@curl -s -o /dev/null -w "%{http_code}" http://localhost:8084/health 2>/dev/null | \
		grep -q 200 && echo "$(GREEN)âœ“ OK$(NC)" || echo "$(RED)âœ— DOWN$(NC)"
	@echo "$(BLUE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"

# ãƒ­ã‚°è¡¨ç¤º
dev-logs:
	@echo "$(CYAN)ðŸ“ æœ€æ–°ãƒ­ã‚° (Ctrl+C ã§çµ‚äº†)$(NC)"
	@tail -f $(LOG_DIR)/*.log

# ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
dev-clean:
	@echo "$(YELLOW)ðŸ§¹ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­...$(NC)"
	@$(MAKE) -f Makefile.local dev-stop
	@rm -rf $(LOG_DIR) $(PID_DIR) $(BIN_DIR)
	@echo "$(GREEN)âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†$(NC)"

# ===========================
# å†…éƒ¨ãƒ˜ãƒ«ãƒ‘ãƒ¼
# ===========================

_check-redis:
	@if nc -z localhost 6379 2>/dev/null; then \
		echo "$(GREEN)âœ“ Redis èµ·å‹•ä¸­ (localhost:6379)$(NC)"; \
	else \
		echo "$(RED)âŒ Redis ãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“$(NC)"; \
		echo "$(YELLOW)   èµ·å‹•ã—ã¦ãã ã•ã„: redis-server$(NC)"; \
		echo "$(YELLOW)   ã¾ãŸã¯: docker run -d -p 6379:6379 redis:7-alpine$(NC)"; \
		exit 1; \
	fi

_start-auth:
	@echo "$(BLUE)  Auth Service ãƒ“ãƒ«ãƒ‰ä¸­...$(NC)"
	@cd services/auth-service && go build -o $(BIN_DIR)/auth-service .
	@echo "$(BLUE)  Auth Service èµ·å‹•ä¸­... (ãƒãƒ¼ãƒˆ: 18091)$(NC)"
	@PORT=18091 $(BIN_DIR)/auth-service > $(LOG_DIR)/auth-service.log 2>&1 & echo $$! > $(PID_DIR)/auth-service.pid

_start-user:
	@echo "$(BLUE)  User Service ãƒ“ãƒ«ãƒ‰ä¸­...$(NC)"
	@cd services/user-service && go build -o $(BIN_DIR)/user-service .
	@echo "$(BLUE)  User Service èµ·å‹•ä¸­... (ãƒãƒ¼ãƒˆ: 18092)$(NC)"
	@PORT=18092 $(BIN_DIR)/user-service > $(LOG_DIR)/user-service.log 2>&1 & echo $$! > $(PID_DIR)/user-service.pid

_start-pet:
	@echo "$(BLUE)  Pet Service ãƒ“ãƒ«ãƒ‰ä¸­...$(NC)"
	@cd services/pet-service && go build -o $(BIN_DIR)/pet-service .
	@echo "$(BLUE)  Pet Service èµ·å‹•ä¸­... (ãƒãƒ¼ãƒˆ: 8083)$(NC)"
	@PORT=8083 $(BIN_DIR)/pet-service > $(LOG_DIR)/pet-service.log 2>&1 & echo $$! > $(PID_DIR)/pet-service.pid

_start-match:
	@echo "$(BLUE)  Match Service ãƒ“ãƒ«ãƒ‰ä¸­...$(NC)"
	@cd services/match-service && go build -o $(BIN_DIR)/match-service .
	@echo "$(BLUE)  Match Service èµ·å‹•ä¸­... (ãƒãƒ¼ãƒˆ: 8084)$(NC)"
	@PORT=8084 $(BIN_DIR)/match-service > $(LOG_DIR)/match-service.log 2>&1 & echo $$! > $(PID_DIR)/match-service.pid

_start-gateway:
	@echo "$(BLUE)  API Gateway ãƒ“ãƒ«ãƒ‰ä¸­...$(NC)"
	@cd services/api-gateway && go build -o $(BIN_DIR)/api-gateway .
	@echo "$(BLUE)  API Gateway èµ·å‹•ä¸­... (ãƒãƒ¼ãƒˆ: 8080)$(NC)"
	@AUTH_SERVICE_URL=http://localhost:18091 \
		USER_SERVICE_URL=http://localhost:18092 \
		PET_SERVICE_URL=http://localhost:8083 \
		MATCH_SERVICE_URL=http://localhost:8084 \
		PORT=8080 \
		$(BIN_DIR)/api-gateway > $(LOG_DIR)/api-gateway.log 2>&1 & echo $$! > $(PID_DIR)/api-gateway.pid
