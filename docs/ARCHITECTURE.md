# アーキテクチャドキュメント

## システム構成図

```
┌─────────────────────────────────────────────────────────────────┐
│                         クライアント層                           │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐      │
│  │   Web App    │    │  Mobile App  │    │    Admin     │      │
│  │  (Next.js)   │    │(React Native)│    │   Console    │      │
│  │  Port: 3000  │    │  Expo SDK    │    │              │      │
│  └──────┬───────┘    └──────┬───────┘    └──────┬───────┘      │
└─────────┼───────────────────┼───────────────────┼───────────────┘
          │                   │                   │
          └───────────────────┼───────────────────┘
                              │
┌─────────────────────────────┼───────────────────────────────────┐
│                        API Gateway                               │
│  ┌──────────────────────────┴──────────────────────────────┐    │
│  │                  API Gateway (8080)                      │    │
│  │  - ルーティング                                          │    │
│  │  - 認証・認可                                            │    │
│  │  - レート制限                                            │    │
│  │  - CORS                                                  │    │
│  │  - リクエストログ                                        │    │
│  └──────────────────────────┬──────────────────────────────┘    │
└─────────────────────────────┼───────────────────────────────────┘
                              │
┌─────────────────────────────┼───────────────────────────────────┐
│                      マイクロサービス層                          │
├─────────────────────────────┼───────────────────────────────────┤
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌────────┐│
│  │  Auth   │  │   Pet   │  │  Match  │  │ Inquiry │  │  User  ││
│  │ Service │  │ Service │  │ Service │  │ Service │  │Service ││
│  │  8081   │  │  8083   │  │  8084   │  │  8086   │  │  8082  ││
│  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘  └───┬────┘│
└───────┼────────────┼────────────┼────────────┼───────────┼──────┘
        │            │            │            │           │
┌───────┼────────────┼────────────┼────────────┼───────────┼──────┐
│       │         共有ライブラリ (shared/)     │           │      │
│  ┌────┴────────────┴────────────┴────────────┴───────────┴────┐ │
│  │  config/ | middleware/ | errors/ | logger/ | validator/   │ │
│  └────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────┼───────────────────────────────────┐
│                        データ層                                  │
├─────────────────────────────┼───────────────────────────────────┤
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐      │
│  │  PostgreSQL  │    │    Redis     │    │    MinIO     │      │
│  │   (5432)     │    │   (6379)     │    │   (9000)     │      │
│  │  永続データ   │    │  キャッシュ   │    │  画像保存    │      │
│  └──────────────┘    └──────────────┘    └──────────────┘      │
└─────────────────────────────────────────────────────────────────┘
```

## サービス構成

### Auth Service (8081)
- ユーザー認証・認可
- JWT発行・検証
- パスワード管理
- セッション管理（Redis）

### Pet Service (8083)
- ペット情報のCRUD
- 画像管理（MinIO連携）
- 検索・フィルタリング

### Match Service (8084)
- マッチングアルゴリズム
- レコメンデーション

### Inquiry Service (8086)
- 問い合わせ管理
- 応募管理

### User Service (8082)
- ユーザープロフィール
- お気に入り管理

## 共有ライブラリ (shared/)

```
shared/
├── config/          # 環境設定
│   └── config.go    # 設定ロード
├── middleware/      # ミドルウェア
│   ├── auth.go      # 認証
│   ├── cors.go      # CORS
│   ├── rate_limit.go # レート制限
│   ├── logging.go   # ロギング
│   └── error_handler.go # エラーハンドリング
├── errors/          # エラー定義
│   └── errors.go    # カスタムエラー
├── logger/          # ロギング
│   └── logger.go    # Zapロガー
├── validator/       # バリデーション
│   ├── password.go  # パスワード検証
│   └── messages.go  # エラーメッセージ
└── utils/           # ユーティリティ
    ├── jwt.go       # JWT処理
    └── redis.go     # Redis接続
```

## フロントエンド構成

### Web App (Next.js 15)

```
web-app/
├── app/              # App Router
│   ├── layout.tsx    # ルートレイアウト
│   ├── page.tsx      # ホームページ
│   ├── cats/         # 猫関連ページ
│   ├── auth/         # 認証ページ
│   └── ...
├── components/       # 再利用コンポーネント
├── contexts/         # React Context
├── hooks/            # カスタムフック
├── lib/              # ユーティリティ
│   ├── api.ts        # APIクライアント
│   ├── auth.ts       # 認証ロジック
│   ├── cache.ts      # キャッシュ管理
│   ├── logger.ts     # ロギング
│   └── errorHandler.ts # エラーハンドリング
└── types/            # 型定義
```

### Mobile App (React Native + Expo)

```
frontend/
├── app/              # Expo Router
├── components/       # 共有コンポーネント
├── services/         # サービス層
│   ├── api/          # API通信
│   ├── storage/      # ストレージ
│   └── auth/         # 認証
├── hooks/            # カスタムフック
└── types/            # 型定義
```

## データフロー

### 認証フロー

```
1. ユーザー → ログイン要求
2. Web/Mobile → POST /auth/login
3. API Gateway → Auth Service
4. Auth Service → Redis (セッション保存)
5. Auth Service → JWT発行
6. Web/Mobile → localStorage/SecureStore保存
```

### APIリクエストフロー

```
1. クライアント → APIリクエスト + Bearer Token
2. API Gateway → トークン検証
3. API Gateway → レート制限チェック
4. 対象サービス → ビジネスロジック実行
5. サービス → レスポンス
6. API Gateway → ログ記録
7. クライアント → レスポンス受信
```

## 技術選定理由

### Go + Gin
- 高パフォーマンス
- シンプルな構文
- 強い型安全性
- 優秀な並行処理

### Next.js 15
- App Router (Server Components)
- 優れたSEO
- 画像最適化
- TypeScript完全サポート

### React Native + Expo
- クロスプラットフォーム
- ネイティブパフォーマンス
- Expo SDKの豊富な機能

### PostgreSQL
- 堅牢性
- JSON型サポート
- 高度なクエリ機能

### Redis
- 高速キャッシュ
- セッション管理
- レート制限
